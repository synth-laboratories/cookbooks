# MIPRO: Multi-Instruction Prompt Optimization

Interactive walkthrough for prompt optimization using MIPRO on the Banking77 intent classification task.

## Overview

MIPRO uses **Bayesian optimization (TPE)** to find optimal:
- **Instructions**: System prompts generated by a meta-model
- **Few-shot demonstrations**: Examples selected from training data
- **Combinations**: Best pairing of instructions and demos

This approach is particularly effective for:
- Instruction-following tasks with clear structure
- Tasks where few-shot examples improve performance
- Faster convergence than genetic methods (GEPA)

## Quick Start

```bash
# Run the interactive walkthrough
bash run_interactive.sh
```

The script guides you through each step with explanations.

## Prerequisites

| Requirement | Description |
|-------------|-------------|
| Python 3.11+ | With synth-ai package |
| SYNTH_API_KEY | Backend authentication ([get one here](https://usesynth.ai)) |
| OPENAI_API_KEY | LLM inference (or GROQ_API_KEY) |

## What This Walkthrough Does

```
┌─────────────────────────────────────────────────────────────────┐
│                    MIPRO Optimization Flow                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step 1: Prerequisites Check                                     │
│     └─→ Verify Python, API keys, synth-ai package               │
│                                                                  │
│  Step 2: Generate ENVIRONMENT_API_KEY                            │
│     └─→ Create authentication key for task app                  │
│                                                                  │
│  Step 3: Start Banking77 Task App                                │
│     └─→ Local server evaluating prompts on Banking77            │
│                                                                  │
│  Step 4: Create MIPRO Configuration                              │
│     └─→ Set bootstrap seeds, iterations, demo count             │
│                                                                  │
│  Step 5: Submit Optimization Job                                 │
│     └─→ Bootstrap generates candidates, TPE optimizes           │
│                                                                  │
│  Step 6: Review Results                                          │
│     └─→ Best prompt, demos selected, score progression          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Step-by-Step Guide

### Step 1: Environment Setup

The script checks for:
```bash
# Required environment variables
export SYNTH_API_KEY="your-synth-api-key"
export OPENAI_API_KEY="your-openai-key"  # or GROQ_API_KEY
```

**Expected output:**
```
Checking prerequisites...

✓ Python installed: Python 3.11.4
✓ synth-ai package installed
✓ SYNTH_API_KEY is set: sk-synth-...
✓ OPENAI_API_KEY is set: sk-...
✓ cloudflared installed (tunnel available)

All prerequisites met!
```

### Step 2: Generate ENVIRONMENT_API_KEY

This creates an authentication key for the task app:

```bash
Generating ENVIRONMENT_API_KEY...
✓ ENVIRONMENT_API_KEY generated: 8f3a2b1c-4d5e-6f7g...

Registering key with backend...
✅ Key registered with backend
```

### Step 3: Start Task App

The Banking77 task app starts locally on port 8002:

```bash
Starting task app in background...
Task app PID: 12345
Waiting for task app to start...
✓ Task app is running at http://localhost:8002

Fetching task info...
{
    "task_app_id": "banking77_intent_classification",
    "dataset_size": 3080,
    "labels": ["activate_my_card", "age_limit", "apple_pay_or_google_pay", ...]
}
```

### Step 4: Create Configuration

The script generates `mipro_config.toml`:

```toml
[prompt_learning]
algorithm = "mipro"
task_app_url = "http://localhost:8002"

[prompt_learning.mipro]
# Optimization
num_iterations = 10      # TPE optimization rounds
top_k = 2                # Candidates to keep

# Bootstrap
num_bootstrap_seeds = 3  # Bootstrap samples
num_instructions_per_module = 4  # Instruction variants

# Demonstrations
num_demos = 2            # Few-shot examples
optimize_instructions = true
optimize_demos = true
```

### Step 5: Submit Optimization Job

```bash
Submitting MIPRO optimization job...

Executing: uvx synth-ai train "/tmp/mipro_walkthrough/mipro_config.toml" --poll

========================================
MIPRO Prompt Optimization
========================================
Job ID: mipro_banking77_1234567890
Status: running

Phase 1: Bootstrap
  Generating instruction candidates...
  - Seed 1/3: 4 instructions generated
  - Seed 2/3: 4 instructions generated
  - Seed 3/3: 4 instructions generated
  Total instructions: 12

  Sampling demonstrations...
  - Demo pool size: 50
  ✓ Bootstrap complete

Phase 2: TPE Optimization
  Iteration 1/10... score: 0.45
  Iteration 2/10... score: 0.52
  Iteration 3/10... score: 0.48
  Iteration 4/10... score: 0.56
  Iteration 5/10... score: 0.58
  Iteration 6/10... score: 0.55
  Iteration 7/10... score: 0.61
  Iteration 8/10... score: 0.63
  Iteration 9/10... score: 0.60
  Iteration 10/10... score: 0.65

========================================
Optimization Complete
========================================
Best Score: 0.65
Total Iterations: 10
Total Evaluations: 100
```

### Step 6: Review Results

```bash
Results directory contents:
-rw-r--r--  1 user  staff  2048 Nov 28 12:00 best_prompt.json
-rw-r--r--  1 user  staff  4096 Nov 28 12:00 score_history.json
-rw-r--r--  1 user  staff  1024 Nov 28 12:00 job_metadata.json
-rw-r--r--  1 user  staff  2048 Nov 28 12:00 selected_demos.json

Found result file: /tmp/mipro_walkthrough/results/best_prompt.json
Contents:
{
  "instruction": {
    "role": "system",
    "content": "You are a banking intent classifier. Analyze customer messages..."
  },
  "demonstrations": [
    {"query": "When will my card arrive?", "label": "card_arrival"},
    {"query": "I was charged twice", "label": "transaction_charged_twice"}
  ]
}
```

## Configuration Reference

### MIPRO Parameters

| Parameter | Default | Description |
|-----------|---------|-------------|
| `num_iterations` | 10 | TPE optimization iterations |
| `top_k` | 2 | Top candidates for final evaluation |
| `num_bootstrap_seeds` | 3 | Bootstrap samples |
| `num_instructions_per_module` | 4 | Instruction variants per seed |
| `num_demos` | 2 | Few-shot demonstrations |
| `optimize_instructions` | true | Whether to optimize instructions |
| `optimize_demos` | true | Whether to optimize demos |

### Termination Config

| Parameter | Default | Description |
|-----------|---------|-------------|
| `budget` | 100 | Maximum prompt evaluations |
| `max_time_seconds` | 1800 | Maximum runtime (30 min) |
| `target_score` | 0.95 | Early stopping threshold |

### Tuning Tips

**For faster iteration (walkthroughs):**
```toml
num_iterations = 10
num_bootstrap_seeds = 3
num_instructions_per_module = 4
budget = 100
```

**For better results (production):**
```toml
num_iterations = 50
num_bootstrap_seeds = 10
num_instructions_per_module = 10
budget = 1000
```

## How MIPRO Works

```
┌─────────────────────────────────────────────────────────────────┐
│                    PHASE 1: BOOTSTRAP                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Initial Prompt                                                  │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────┐                    │
│  │           META-MODEL                     │                    │
│  │   (generates instruction variants)       │                    │
│  └─────────────────────────────────────────┘                    │
│       │                                                          │
│       ├──→ "Classify the banking intent..."                     │
│       ├──→ "You are an intent classifier..."                    │
│       ├──→ "Determine the customer's need..."                   │
│       └──→ "Analyze and categorize..."                          │
│                                                                  │
│  Training Data                                                   │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────────────────────────────────┐                    │
│  │       DEMO SAMPLING                      │                    │
│  │   (select representative examples)       │                    │
│  └─────────────────────────────────────────┘                    │
│       │                                                          │
│       └──→ Demo pool: [(query, label), ...]                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    PHASE 2: TPE OPTIMIZATION                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Search Space                                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Instructions × Demos = Combinations to search            │   │
│  │                                                           │   │
│  │  [Inst 1] × [Demo A, Demo B] = Config 1                  │   │
│  │  [Inst 2] × [Demo A, Demo C] = Config 2                  │   │
│  │  [Inst 3] × [Demo B, Demo D] = Config 3                  │   │
│  │  ...                                                      │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  TPE Algorithm                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  1. Sample configuration based on past performance        │   │
│  │  2. Evaluate on Banking77 samples                         │   │
│  │  3. Update probability models (good vs bad configs)       │   │
│  │  4. Repeat for num_iterations                             │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Iteration 1:  Config 5  → Score: 0.45                          │
│  Iteration 2:  Config 2  → Score: 0.52                          │
│  Iteration 3:  Config 8  → Score: 0.48                          │
│  ...                                                             │
│  Iteration 10: Config 2  → Score: 0.65 (best)                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Troubleshooting

### Task App Not Starting

```bash
# Check if port is in use
lsof -i :8002

# Kill existing process
lsof -ti :8002 | xargs kill -9

# Check task app logs
cat /tmp/mipro_walkthrough/task_app.log
```

### Low Optimization Scores

1. **Increase iterations**: More TPE samples = better optimization
   ```toml
   num_iterations = 30
   ```

2. **Increase bootstrap diversity**: More instruction variants
   ```toml
   num_bootstrap_seeds = 5
   num_instructions_per_module = 8
   ```

3. **Add more demonstrations**: Sometimes more context helps
   ```toml
   num_demos = 4
   ```

### Job Timeout

Increase the time limit:
```toml
max_time_seconds = 3600  # 1 hour
```

## Comparison with GEPA

| Aspect | MIPRO | GEPA |
|--------|-------|------|
| **Approach** | Bayesian (TPE) | Genetic evolution |
| **Instruction gen** | Meta-model | Mutation operators |
| **Demo selection** | Optimized jointly | Fixed or evolved |
| **Convergence** | Faster | Slower |
| **Exploration** | Moderate | High |
| **Best for** | Instruction tasks | Complex structures |

### When to Use MIPRO

Choose MIPRO when:
- Task has clear instruction-following structure
- Few-shot examples improve performance
- You want faster convergence
- You have good training examples for demos

### When to Use GEPA

Choose GEPA when:
- Prompt structure is complex (multiple sections)
- You need diverse exploration
- No good demo examples available
- Task benefits from creative prompt variations

### Try Both!

```bash
# Run MIPRO
bash run_interactive.sh

# Run GEPA (same task, same model)
bash ../gepa/run_interactive.sh

# Compare results
# - Which achieved higher score?
# - Which prompt is more interpretable?
# - Which converged faster?
```

## Files Created

After running the walkthrough:

```
/tmp/mipro_walkthrough/
├── env_key.txt            # ENVIRONMENT_API_KEY
├── mipro_config.toml      # Generated configuration
├── task_app.log           # Task app output
└── results/
    ├── best_prompt.json   # Optimized prompt + demos
    ├── score_history.json # Score progression
    ├── job_metadata.json  # Job details
    └── selected_demos.json # Chosen demonstrations
```

## Next Steps

1. **Try GEPA**: `bash ../gepa/run_interactive.sh`
2. **Compare results**: Check score and prompt quality
3. **Production use**: Copy optimized prompt to your application
4. **Experiment**: Adjust parameters and re-run

## See Also

- [GEPA Walkthrough](../gepa/) - Genetic evolution alternative
- [Main README](../README.md) - Overview of all prompt learning approaches
- [SDK Examples](../sdk/) - Programmatic Python interface
- [CLI Scripts](../cli/) - Non-interactive command-line runners
